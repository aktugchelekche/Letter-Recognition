
# import libraries
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from tensorflow.keras.models import load_model
import cv2
import io
from io import StringIO
from io import BytesIO
from imageio import imread

import tensorflow as tf
import uuid
import os
import numpy as np
from PIL import Image
import base64



# Load the trained model
trained_model = load_model("character_recog_model.h5")

# Recompile the model 
trained_model.compile(optimizer="adam", loss="binary_crossentropy", metrics = ["accuracy"])

# Create words dictionary

words = {0:'A',1:'B',2:'C',3:'D',4:'E',5:'F',6:'G',7:'H',8:'I',9:'J',10:'K',11:'L',12:'M',13:'N',14:'O',15:'P',16:'Q',17:'R',18:'S',19:'T',20:'U',21:'V',22:'W',23:'X', 24:'Y',25:'Z'}

# Function to predict letter characters using the trained model
def predict_letter(base64_img):

    image_webP = Image.open((io.BytesIO(base64.b64decode(base64_img))))
    # print("NEW CONVERTED IMAGE: "+image_webP)
    # Read the image using cv2
    # image = cv2.imread(img_path)
    # print(base64_img)
    # make copy of original image, copy will be used to change colors
    image_RGB = image_webP.convert("RGB")

    #convert to correct format
    image = np.float32(image_RGB)

    image_copy = image.copy()

    # convert image to RGB using cvtColor
    # error explanation: https://stackoverflow.com/questions/54249728/opencv-typeerror-expected-cvumat-for-argument-src-what-is-this
    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)

    # Resize image to 400 x 400 size
    image = cv2.resize(image, (400,400))

    # Add blur to image and greyscale (need to greyscale as cv.threshold needs greyscale images)
    image_copy = cv2.GaussianBlur(image_copy, (7,7), 0)
    grey_image = cv2.cvtColor(image_copy, cv2.COLOR_BGR2GRAY)


    # Separate object from background pixels using thresholding
    # https://docs.opencv.org/4.x/d7/d4d/tutorial_py_thresholding.html
    _, img_thresh = cv2.threshold(grey_image, 100, 255, cv2.THRESH_BINARY_INV)

    # Resize and reshape image to fit trained_model requirements
    final_image = cv2.resize(img_thresh, (28,28))
    final_image = np.reshape(final_image, (1, 28, 28, 1))

    # Make prediction using the trained_model
    prediction = words[np.argmax(trained_model.predict(final_image))]

    print(f"The prediction is: {prediction}" )
    return prediction

#Test that file is working 
if __name__ == '__main__':
    predict_letter("UklGRoYaAABXRUJQVlA4IHoaAAAQUgGdASroA+gDPu12u1Wpp60pIROoUaAdiWlu/B25MsNG8OCf/9MN/7ZjHuY5+jO8n+6/8//DejdmaEv+U7TsJfr8e78xTB7+f85/7PXNzxfgvEYoCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qagJldTupqAmV1O6moCZXU7qWuCYe6117omawH4C3dYXboAdLtryByNO7dIYhm8AG/zEyup3U1ATK6ndTUBMrqd1NQEyup3TZzZ+Plh/9bDU/4sQOuLpWZw86vkoeJtRD/wBMrqd1NQEyup3U1ATK6ndTUBModynA8+rpsJIMzpZQ3qV0A+sPasI8QyC0UWMTUBMrqd1NQEyup3U1ATK6ndS1wA+5qcxuqf0fUrEmxz0rfkZHQwjm/6RaagJldTupqAmV1O6moCZXU6NAE+tX6WerS46CfubdVPmZ520crHAlMhBZtb7jrMvELp3U1ATK6ndTUBMGACFqtd7Yo5bWnFHGvvbdeTplC4BgwkWhxMpqAmV1O6moCZXU7qagJlbEoobXSFy6lEi+DjptMU3upY9F0QRA7iq5LMvELp3U1ATK6ndTUBMrYi0rhxWCHBgGraPXR6Dkn4Su+tm3td4AVrD62O/9r0tRfa6zLxC6d1NQEyup3U0//QGm+8LDAjWR9YAer/ZN7zcrQy6+DDwjtuCs8Z+si7X8ItQdrSvZ5IKC1wBo6K1cGNg7hMgCup3U1ATK6ndTUBMrqdEQz/YyYbzTNpgtzwgkf//9XjlAqMztLIPEH1MPAjPNvvxR9DWlfKmZhGcMpAV0undTUBMrqd1NQEyh+tSB2cLkevMt4b9Hq3eH/PBHl4hce6wDu0EvoEJ8OHncrvkFwM2qBCJTZl4hdO6moCZXU7qaeTef5/3nQxrTB4w7GVUlgWgL8EXU6R/C/IbFUYKm+l2too4Y4gbQyYuXHWZeIXTupqAmV1OkyZUk/pxNxGCslEGMpvqLMzK6nRwDB/u/W8s/bouGsQFN+kN7ZldTupqAmV1O6moCLaHV8FStuq3AVEYb6ySng8vELp3ET6bbeqdm+ekPd8YYb/+8sBE+Co9x1mXiF07qagJldSp3TRUeddpXjUWf46DR5W3uOsy8Qv9MwJQpAAK4AYX/6uJT/58r8vELp3U1ATK6ndTUBGDuowCul7KhgukMs4ULp3U1ATK6OjA4clIx7fxFLl2QP/bGnePVmXiF07qagJldTuKFChUwPQkEFl6ItQTNozMrqd1NQEYNGaOBM7ynihIM8dZl4hdO6moCZXR+buVfMxclZ5mR5qvMQundTUBMrqd1NQEyup3U1ATK6ndTUBF/WdmXgBcM3hbQ+eghWZeIXTupqApiL64XHWZeIXTupqAmUQM75yOONlp/CMc0ZdTUBMrqd1NQEyup3U1ATK6ndTUBMrqdHlDNM+OjFH9KJyDy8QundTUBMuq3xXj1Zl4hdO6moCZXU6PSh2SJui0Tfl5L3HWZeIXTupqAmV1O6moCZXU7qagJldSs7Kmn50oFQItHBF1O6moCZXU7qagS4i6ndTUBMrqd1NPMjf4QvMbg2kyup3U1ATK6ndTUBMuq07qagJldTupp//TX+PUkrZH2eusy8QundTUBMr64XHWsa8QundTUBMrqdHd2iYVmmDuUZhyupqAmV1O6moCZXU7qazsAi6ndTUBMrqVr5CzBhrw8nq4qcoXTupqAmV1O6moCZXU7rDsy8QundTUBMG9Mem0FpWK/NBCF07qagJldTupqAmV1O8erMvELp3U0//vz871/0gWuRF33y68QundTUBMrqd1h2ZeIXTupqAmV1O6mi7x7R9XZ5xSk4QhdO6moCZXU7qagS4i6ndTUBMrqd1NP/8HWH1iDiv6eYb7j91O6moCZXU7qagJp0u+K6moCZXU7qagIvtSdwyhXj4PZFa2B4D4ZeIXTupqAmV1O6ms7AIup3U1ATK6ndTRepZIgaA5yR88/ieqNKFZl4hdO6mnlyk4jxnHzni6paV1mXiF07qagJldSttqI+gHNEf/AobrxC6d1NQEyujr6KSb4GEPfNnpoMS9UNyxC6d1NQEyup3U1ATK2IXYyFHSfHaLRGTOoBF1O6moCYNW9IWt686remUoRQ8XA4Mjf7HhrxC6d1NQEyup3U08mdFv/saFIo7rjNfP8xdO6moCZQs5UCcl10aOFDCSyerMvELp3U1ATK6ncU50eZP72YJgm3RPhRw/GZldTupoq40TWOydt59KDs8B+L49BBHJqAmV1O6moCZXU7pti+2hpN5QT5Gn8ySjkDIVdTUBMrqVlpaRg2609QyUetfdptUhDkaBs7qagJldTupqAmV1Klme9K2J3g4YmDcs0C/jMyup3UtClrHAeqVcYMq1k9WzRzmzl1dM7qagJldTupqAmVs910Eucu/Zj7sg81BpQQi6OCLqd1LTy5fCYH8bD4BnMODPxLL2Jwv28vELp3U1ATK6ndTUBFr5cqB9D+W/mOd9mkjeoccxdO6bwXgw052VfyVxfPwRXegrowhj83FRXWZeIXTupqAmV1O6mnkLWCg/OQmnpJIt5jIFG9PRP8hdKlE6aHYVwlRkzsXKNlzM9TSq4rjbm3uOsy8QundTUBMrqdxFxrUecivrzYBlfZLrzul88HSVux1gHZ4wb/e0npJNq9CQcDR1LaBfdiZHhAOxC6d1NQEyup3U1ATK6nRB6/lue3KMK85LZR8bjrrlyv8SQjkH5QGGTLy2X2Zyh03I7Yla3Edv5X6ZrMvELp3U1ATK6ndTUBMIFBNWbLexSXHWHp3U1ATKMf2Vtdj+jDJoXIcVYhdO6moCZXU7qagJldTum7sgU17rxmiGVxtmsvEXk4/fsODlzkumrKkhk6modgIup3U1ATK6ndTUBMrZMECpYlqxFG6n52ZhU1D/hkfRXGgCD4cus67J1NQFMRdTupqAmV1O6moCZXUrzoiSzkUYOwURpguNs0cM9pFXvmjYNvE1nVNuqvELp3U1ATK6ndTUBMrqd1NQGTWrT9UbBZh96R9zNKHSglorsdHggWL+KSFjLlldUtL11mXiF07qagJldTupqAmWUHoDeGnH6uD05dznB0ygJCUEBBlGf51ANWmr8dMzSa4aPrqd1NQEyup3U1ATK6ndTUBMrqd7N6kzd2hhJ4nbIKghMXABKK/6IFH5DnyJsxcdZl4hd8V1NQEyup3U1ATK6ndTUCXEXWM9C0VO6modgK6XTupqAmV1O6moCZXU7qagJp0undTX33TvYvELviupqAmV1O6moCZXU7qagJldTupqAmXVad1NQEyup3U1ATK6ndTUBMrqd1NQFMRdTupqAmV1O6ms7AIup3U1ATK6ndTUBMrqd1NQEyup3U1ATK6nePVmXiF07qagJldTupqAmV1PQQrMvELp3U1ATK+uFx1mXh/AAP79zQgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFN9cxDeO6ClI+lHSROvW0z2mRUHX1wGlmlmjx5GzQgc+7Gj9bAIFRMz4VWZa9ksD1TpVi/wRRXiYkvAvxXOw+lKTEJPqNncyDNLbNLh1gc1DtzqXOlEmRlysrnsx6f+3a00Te7W63kky2iODyPNhBJ+iMRoAAAKvP/1jjqDShAS601VcIAC6Mo7sbPivtEAaTlvmXR03wyzljBOi6pxeAFwTvoEoBUT1LHE0LHgxZyq0HQ2UAMfH5wKYdVwdZHtxCbVVjtWvSQyJO7SD9iUHzRfdvMTMun8AmNAAAJ/ndBDTAAHGGtYmkPV1DfyTN42QfHTdIL8qw9z/YeVqOahZvKa2pI3u6dPwc4SCGhoj8JIHsSPcwR/XFiRqNlP7mItzhIpeJlpVXb9YAABPgbba6/IWAu0xrK4stCvTyQZwkVOegPYmX/yQlbykN2ht8ojbrKfNwg9VVTtZLj66VDph/0Iy/CUSp1tPCIF9wartPygPAUSK6VSAAA4O37lFrxD7KpOUjLnxhJteDcmyNktvcnCugwMqDgjHybkdL+g/D6ZsICYR/301yXt6r2OxZ0vfViWBadtoOXnFQYn3kVBAAJ8WGRcUhBOq5sTZJbBJbzL3RapVja1rj14U3UZHm1xqcCBgOMZB2g1fGVYsyDDA68HcycQDizCC24PkGrN0L4lAAAxKbo8amQyU63ntdbM4MZCoV4mp3YOpiSW8N2dxDbdN0p07Yga8TxwGGdbMnMEHiGdZDXh++OjAATJGEv0vFPoE1abHRIIPXuRa0AeaVWlpzaNrYHD/g2jEKxiCro0IfhqdkzjzMCjCYIu2/7rMAaNAuEAYX6WC9iDy+m1pBarBWMv5WAAOKxnUvyWJiiylDStshp6/ABEDgx8N3bNxjiXDmQDfPq7sQ0ZIXqJkroauD9luRdP2apQxoE6BUCvdy0YxmQOmgNRX4Sg6T5Mpn9x55J6lRvMVqXNVhAIH9JWVxrRGMl1ZQO11tE1z/kJI+KkGc5tpQTynujEo/4Y99hgywZymCCA1UXOc14FgtjJS8ZSMmQDJel5D4JMtw7Dd1aFP59CyU8RITfQ0ytaOqQigABWNv+npOFtBJyWgRFmoIw7hcMuiaBrt9KhL18Vr6BxlHPcHT1nWCj4fjra/vlftsIUo/MRjxJySqr6eK8xTq4RPi8bOLT1HQDx/R0NThOaYlnHKBbYvyyWKNm6UylanKeBqvvP0ZdMd18P3vkAs0XT7qQNvSFUk4wjPhqYrLT1NlgC8BAHF1o0toVVGsy+dLwciC+9720OKQttXJU7GmEnGNveUOxucxgajtHDnCObWW7vRGekfiCSSlUaVbbsyuh2Oyk2dCmctJqL7Z6geVr7APuw5PAVoF+m+QVA6cHDhUTmxM/A3vpVRUn7tcFVtmmyOrfwAF/pcewqOpI8V6NzujBigd1PGnESmIpuHWgXOfDX6vx5Lo9X43WPxtAWMxhLI1a6VIzUmDoZh7rg/14UyLt2lbq9uWBksjduLlZ5TodCuoe30ZBERecAAbutD44pOOUGoZDWH+bl47vDMKUPIh9tu0mMDCrCgJGfopZJzR3oFrQL27m+PWcQ32cgMnKG6pF5GVKTAUi7yXoLAOA4jbGn2E9dJ1O/5P6srP3GyH1GPBy4sZCYKl4s0P0AAIuKyJiifhl3fmRSPwvHPSI7l1y82hDujYWXihmzfzSd7NVe9J2HOrIVzYFj00gPUHGb/CD0LnzE+OjFXBvLDUgSmx7xHYnmf82DzA9UXap5Uufq4caqC1/3fQca1DMuFdfhXBbpXlkSQRW6PiDBCAbubzBgfcWWLwqcAfLhU46TU/oSRRDOFpJX1UkmUPbTgzAscg8r6KOYuhK211xatjU4VK4GadqG9YgqjdJrEelW5iwgZXuHfqaADpn6q/U21G6Tx2c9GTaGYsK5jIyD2u6t94630R94vWli3A8HnPtwoU9QAQBUXwZi+ZGPyC9PgrLhD0GVFTEi9ZKTrZ7wXaO9Pjvfsu8RgO9CTFyoqugKDAuLjNDXl6e06Hy4Kdt9W36UiAqLg8Ie8yNRpOEr0AzGflyKhlWfKwsYSmOJNODv5gteIqlgjysigBJ7/UABtayJx+InIp1CAyRkgAEe9/uuKoa5I3y7e1NeThB1ztEBrtTIdQTSsIaK4Heu8l09WbN0OEy+ak/zUJ16AEuHwkmamv3weYyIzJPgHpl03hBAdWOBO+1tMkLcZGelnlKCUC+9tkAB3UhRwf+pI6epIUMqYAecuZdEKsBBu6NZfgZ96/qyuySvQm4cJze3IYe9AChn0BAnyICI6exAkKG2iEpN2TKJUU4JoIfBSuA3u8m5gAHDeSDMJKvkwDDCP6BZKrEl8jgf2A/JesIAYgJyFCHBOxkAyNi5vEcUISNHlUJuEoZSQjWXcuDbAw9CAIBGU+69F08KWa0dNK4SAMLwuIDYKdbBQwXgIItOp+bE0yq3QOf1AN8hWotF0he92yvAQP0S6AaLgsVGi4pd0s2AhqnU+zBJyF6dSgp3ujDMWSkeul+C1bgmdqToYac9uhfqpEqnHH5x+SrargE5lh6IdVfXeDppFCsAeRnEAxesNjOLJ/dJoSTSYzSVG6LAbBQbZ5RRlpIGSVFovAQ0kFWNnpDRnzlHsM97zakxWwxlaAJn4VlIAUGWGzYJRKjfAKxk6GGeeLDjHv67+MbAPbHvd8ZILzAXxaAJNwvTqUFPH2p46QBs53QdV2BvBOcgZ8v1DWC3Qlxj02H2GhlIUGWHoh18hvVlK05jHSACnQeEFUpMBPqMEPqDTxaOlrLLI66Re0c2uRmLk4A0tPop+BNAwsYYuAgi2kK+2kpWauuESHbkAimv5TsucMsUZj1RX1i/ki2MLYDfIVqLI/0BCFogQB6NFumQsYEJCuMiGIOR7Ts6mgOkH/dHmVO3I/eW8oCzYE2CFYVuE4MfonGEqvo1eoK8fnezJZz5Z2jnQShdbx3nnLkb546itlgICsgbPLqneXThFjBVL1+1uE/0qlQrWn7Mc3URxv7lRORidbZTgI6BQP8zNqfb3s9bJZVvBY5IVaAxHVEik5UD6VYzJ5aHLXd/HDHY/bOCS9ZOVvuCKkriMnlLwOS5cov9gRW5++Ai/AQEIqSD4/AfXNWwUG6YPXS6D3BllLzgbVQBYjnrPkIVpYdsIB6vKig0A11p+dBDGcWEqVT9AJOYfThY6s7wSdNHnzVmFMzY/mtOmBNR91puFDkMeXHITl7xjeeL0azhc014IAAKAVoRm7ra+84sYTj0hksrVSbmFirNkqquaJX0KQWm0hN+FenGUWA/93sJ4lzePibUckPRgDv9E51bFjj4K2i1kqZrosGXPFI3esZpVhxKPyelB2w/YXowAFwylijjf2uZ3UHDeSOd5gksNAuyTLlcRi16Ao5hrsXcI/f/mJdAIenZMnUQW5S2xBWsaI5qe8h4uhiqxbpojMhdrMscBNwgACTIsSasT0TYDHqAQ/GiFMA8R9E+00M5bmlERnhy1hVvFC4AhUODEWTjzqeuMWOeGxyxudH1a8MOw94ztF9Zso6PdU9y5iQfNI1BVz1cUvl/tXAAk+mbT/TlR5HA72tZjRUGZ/SnZ99hXvDqvUKfVrbOOemtq2g+f9QD0o40Uxn7vZGfXunQAqg9k0reyK641Ob2/P2Zw5kYEWpn7aHVWo8HN16UkNrAAB7yDEuV7h4outaaSl3fGYX+16AWu/oGnFBhUnZA7zPBh/BQmifwp0rhQZ/cXvh3TZiZ3IkXqCXkpp+yKbqZAOJ2P23vIiW6+UJsBSNAU/I9sL//OXMTBlUbA9DWWUABXDHmjv/i+2aH3lHC5xjM75xJv9pQJICtMs42GHAQGt7Abp87G1wjYPQiKgl+VYYGk/S6OFjwLDtZqK4DVMacB1atpsoIeOuUQ9hA8WMXveUlyvumSjD7D2TCYr6gYIAAQCeztds9DGJmvZgs8wpXDbopyP8NB0HZd51GKh2AQgzCGjDl9L9gjnKrg/99W+L4evL+OHY3b+Z6czBna0AMxSOXZ4OjTCX+nb+zpnBgSTpvTZTCmNrpNTGVaONt47PzuzNDDNUKUvvzGNmCB5sgbmvdipQ3YAAGJNnhEl83zytUBdYqOMUPT2dh3ngldc0X1H9cbk0Jf43/Rnyc5MqI67NZZ2XXTe/YUmg8HCLTKFq8TtDQ8aa4yI3nlsTbVZqqkpdrXz2B2edK1m439ko0vs/1kTQISoJLMXFzhrIQ5LU2hEYv+9SgE6KYUjLxJeS3G3zwLVGIm1l7iCNAjkjwMUezvk2ioIAA0P+SC+iMopEzdXxgjoZU7B/EnT1em35uNaMPCrtduUVDLlna2f0MNvvE++qnfoz3zdAPQ6TLRUgBf5QPNIm5HYZjFiQqRc5/nyzBJt1+12ZDxN6NEMjsychRE0E3SvY5ilXGLpLktnAGv4TGc6TuRn6cwU+dsW5ax5bQAAI/3eMGFJU5EsL7r3Da5txsS4qNJtE/sL2h4kcRAjRaSyG5xFSVmBst17/SNzAVwg4ZgtXC6XjFdHPhAADnIgiJUN6OsUWvmsYZRgVoKW8bEHBGqXheniS5Ao34mSm8g2zv0m3zYDqmd2yzERRLCMi8tT3x9GrpC8BABImlx1M4FmTYNElkDF0CtsCfkkMAQTF3zIoN3LjgPol0uEhr2DcuKX/eICIiky/uoCrt0uv5csQc1h8R8fZU9Rlh3wABgw4c7sLznl4jI4DuUbeU+TiChTHWKkTfg59WqPoqnm6tPCgr0nVqkwn4yEM2W7qsxG5mtFcQfDL0gzQvSJJuijbKmF89UxTsRQcndyzu8DYgACL4Qlr57+E13p490ov1+470jW4QNnD1Kpf4CwnYOJQtIcTYQLm9xoJ53RTiIM5JyCMtLs+yiJcWQU1nhDp1Kmehw30j3BUWho7Ve9MVxKgZlwHxm5KBURFfIjwEAKFKvlg0PFKU2zgYlTjZGqI98u+awUQrFnZSdUiVdJzsHsbPp0cqVx/thgcm3IZnxDYwhAQCsOaYQpxCunGmSU75EFPN+1UUBU5PVe2eXAMd04Q1uz6tMzlcb+kD+CGFQhSpQze9jdas0XfASjJYrFqWoL+nu5yea47uVHYAr0lq0Sr3ZAADWGY8KxVpFOrINZU3hkqzkHdEdGSbgb6Q1+Mo14dEDWUeRIC4l3IOrrBewADPPPFvxzh3OTQvduf8BzxnnyBWSZQMI2+vzR8rH5mStky+9hKS6fRPABQAstcugA9Q08MHwRvqwRSYIANgX5JJktgXfwoG3BatwAN4HAZD35o8rT6IEACcekxgHLYr4enqyr6sAAFAEfeU19NxNroAATj0mMA/qTY095+3j8AAAA")

